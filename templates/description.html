<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Description</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <div class="container mt-5">
        {% if anime %}
            <h1>{{ anime['Name'] }} {% if anime['English name'] == "UNKNOWN" %}{% else %}({{ anime['English name'] }}){% endif %}</h1>
            <div class="rating-section">
                <label for="rating">Your Rating (1-10):</label>
                <input type="number" id="rating" name="rating" min="1" max="10" value="{{ session.get('rating_' + request.args.get('Mod_name', ''), '') }}">
                <button onclick="submitRating()">Submit</button>
                <button onclick="resetRating()">Reset</button>
            </div>

            <p>Your rating: <span id="currentRating">{{ session.get('rating_' + request.args.get('Mod_name', ''), 'N/A') }}</span></p>

            <script>
            function submitRating() {
                var modName = '{{ request.args.get('Mod_name', '') }}';  // Fetch Mod_name from the URL query parameters
                var rating = document.getElementById('rating').value;
                fetch('/rate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'mod_name=' + encodeURIComponent(modName) + '&rating=' + rating
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          console.log('Rating submitted:', data);
                          document.getElementById('currentRating').innerText = rating;  // Update the displayed rating
                      } else {
                          console.error('Failed to submit rating');
                      }
                  });
            }

            function resetRating() {
                var modName = '{{ request.args.get('Mod_name', '') }}';  // Fetch Mod_name from the URL query parameters
                fetch('/reset_rating', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'mod_name=' + encodeURIComponent(modName)
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          console.log('Rating reset:', data);
                          document.getElementById('rating').value = '';  // Reset the rating input field
                          document.getElementById('currentRating').innerText = 'N/A';  // Update the displayed rating to N/A
                      } else {
                          console.error('Failed to reset rating');
                      }
                  });
            }

            function retrieveRating() {
                var modName = '{{ request.args.get('Mod_name', '') }}';  // Fetch Mod_name from the URL query parameters
                fetch('/retrieve_rating?mod_name=' + encodeURIComponent(modName))
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Rating retrieved:', data);
                            document.getElementById('currentRating').innerText = data.rating;  // Update the displayed rating
                        } else {
                            console.error('Failed to retrieve rating');
                        }
                    });
            }
            </script>

            <img src="{{ anime['Image URL'] }}" alt="{{ anime['Name'] }}" class="img-fluid">
            <p><strong>Other names:</strong> {{ anime['Other name'] }}</p>
            <p><strong>Genres:</strong> {{ anime['Genres'] }}</p>
            <p><strong>Synopsis:</strong> {{ anime['Synopsis'] }}</p>
            <p><strong>Type:</strong> {{ anime['Type'] }}</p>
            <p><strong>Episodes:</strong> {{ anime['Episodes'] }}</p>
            <p><strong>Aired:</strong> {{ anime['Aired'] }}</p>
            <p><strong>Premiered:</strong> {{ anime['Premiered'] }}</p>
            <p><strong>Status:</strong> {{ anime['Status'] }}</p>
            <p><strong>Studios:</strong> {{ anime['Studios'] }}</p>
            <p><strong>Source:</strong> {{ anime['Source'] }}</p>
            <p><strong>Duration:</strong> {{ anime['Duration'] }}</p>
            <p><strong>Rating:</strong> {{ anime['Rating'] }}</p>
            <p><strong>Rank:</strong> {{ anime['Rank'] }}</p>
            <p><strong>Popularity:</strong> {{ anime['Popularity'] }}</p>
            <p><strong>Favorites:</strong> {{ anime['Favorites'] }}</p>
            <p><strong>Scored By:</strong> {{ anime['Scored By'] }}</p>
            <p><strong>Members:</strong> {{ anime['Members'] }}</p>
        {% else %}
            <h2>No anime found with the given ID.</h2>
        {% endif %}
    </div>
</body>
</html>
